<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人博客系统"><meta name="keywords" content="Nginx, Zabbix, Shell, Python, OPS, HA"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><title>Nginx-反向代理与负载均衡 | Mr.Chen</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx-反向代理与负载均衡</h1><a id="logo" href="/.">Mr.Chen</a><p class="description">感谢平庸与我随行!</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Nginx-反向代理与负载均衡</h1><div class="post-meta"><a href="/post/6325.html#comments" class="comment-count"></a><p><span class="date">Jul 25, 2019</span><span><a href="/categories/Nginx/" class="category">Nginx</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="Nginx反向代理与负载均衡"><a href="#Nginx反向代理与负载均衡" class="headerlink" title="Nginx反向代理与负载均衡"></a>Nginx反向代理与负载均衡</h2><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><ul>
<li>客户端<ul>
<li>Nginx<ul>
<li>应用服务器1（正常）</li>
<li>应用服务器2（宕机）</li>
<li>应用服务器3（正常）</li>
<li>应用服务器4（扩容）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Nginx在AKF扩展立方体的应用"><a href="#Nginx在AKF扩展立方体的应用" class="headerlink" title="Nginx在AKF扩展立方体的应用"></a>Nginx在AKF扩展立方体的应用</h3><ul>
<li>水平扩展（X轴扩展）：基于Round-Robin或者least-connected算法分发请求，不能解决单台数据量大的问题</li>
<li>纵向扩展（Y轴扩展）：基于URL对功能进行分发，需要一台处理的功能，用两台来处理。需要做重构。能够解决数据量上升的问题</li>
<li>竖向扩展（Z轴扩展）：将用户的IP地址或其他信息映射到某个特定的服务或者集群，如CDN</li>
</ul>
<h3 id="负载均衡策略：round-robin"><a href="#负载均衡策略：round-robin" class="headerlink" title="负载均衡策略：round-robin"></a>负载均衡策略：round-robin</h3><table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>upstream name { … }</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>server <em>address</em> [parameters];</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>upstream</code></td>
</tr>
</tbody></table>
<h3 id="指定上游服务地址的upstream与server指令"><a href="#指定上游服务地址的upstream与server指令" class="headerlink" title="指定上游服务地址的upstream与server指令"></a>指定上游服务地址的upstream与server指令</h3><ul>
<li>功能：指定一组上游服务地址，其中，地址可以是域名、IP地址或者unix socket地址。可以在域名或者IP地址后添加端口，如不添加则默认80端口</li>
<li>通用参数：<ul>
<li>backup：指定当前server为备份服务，仅当非备份服务不可用时，请求才会到该server</li>
<li>down：标识此台服务已下线，不再提供服务</li>
</ul>
</li>
</ul>
<h3 id="加权Round-Robin负载均衡算法"><a href="#加权Round-Robin负载均衡算法" class="headerlink" title="加权Round-Robin负载均衡算法"></a>加权Round-Robin负载均衡算法</h3><ul>
<li>功能：<ul>
<li>使用加权轮训的方式访问server指令指定的上游服务</li>
<li>集成在Nginx的upstream框架中</li>
</ul>
</li>
<li>指令：<ul>
<li>weight：服务的权重，默认为1</li>
<li>max_conns：server的最大并发连接数，仅作用于单worker进程。默认是0，表示没有限制</li>
<li>max_fails：在fail_timeout时间段内，最大的失败次数。当达到最大失败数时，会在fail_timeout秒内这台server不允许再次被选择</li>
<li>fail_timeout：<ul>
<li>单位为秒，默认10s，具有两个功能：</li>
<li>指定一段时间后，最大的失败次数为max_fails</li>
<li>到达max_fails后，该server不能访问的时间</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="对上游服务使用keepalived长连接"><a href="#对上游服务使用keepalived长连接" class="headerlink" title="对上游服务使用keepalived长连接"></a>对上游服务使用keepalived长连接</h3><ul>
<li>功能：通过复用连接，降低nginx与上游服务器简历、关闭连接的消耗，提升吞吐量的同时降低时延</li>
<li>模块：ngx_http_upstream_keepalive_module，默认编译进nginx，使用–without-http_upstream_keepalive_moduel移除该模块</li>
<li>配置：<ul>
<li>对上游连接的http头部设定</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_set_header Connection "";</span><br></pre></td></tr></table></figure>

<h4 id="upstream-keepalive的指令"><a href="#upstream-keepalive的指令" class="headerlink" title="upstream_keepalive的指令"></a>upstream_keepalive的指令</h4><table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>keepalive connections;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>upstream</code></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>keepalive_requests number;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td><code>keepalive_requests 100;</code></td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>upstream</code></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>keepalive_timeout timeout;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td><code>keepalive_timeout 60s;</code></td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>upstream</code></td>
</tr>
</tbody></table>
<h3 id="指定上游服务域名解析的resolver指令"><a href="#指定上游服务域名解析的resolver指令" class="headerlink" title="指定上游服务域名解析的resolver指令"></a>指定上游服务域名解析的resolver指令</h3><table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>resolver <em>address</em> … [valid=<em>time</em>] [ipv6=on|off];</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code>, <code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>resolver_timeout time;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td><code>resolver_timeout 30s;</code></td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code>, <code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">roundrobin.conf。配置上游服务9011和9012</span></span><br><span class="line">upstream rrups &#123;</span><br><span class="line">    server 127.0.0.1:9011 weight=2 max_conns=2 max_fails=2 fail_timeout=5;</span><br><span class="line">    server 127.0.0.1:9012;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 10005;</span><br><span class="line">    server_name rrup.dookt.com.cn;</span><br><span class="line">    error_log logs/rrups-error.log info;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://rrups;</span><br><span class="line">        proxy_http_version 1.1;         #上游连接的http头部设定http协议办版本http/1.1</span><br><span class="line">        proxy_set_header Connention "";  #上游连接的http头部设定</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">upserver.conf。9011和9012</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 9011;</span><br><span class="line">    default_type text/plain;</span><br><span class="line">    return 200 '9011 server respomse.\n';</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 9012;</span><br><span class="line">    default_type text/plain;</span><br><span class="line">    return 200 '9012 server respomse.\n';</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">使用curl验证，可以发现和预期一致，（访问两次9011才访问一次9012）</span></span><br><span class="line">[root@openresty01 ~]# curl rrups.dookt.com.cn:10005</span><br><span class="line">9011 server respomse.</span><br><span class="line">[root@openresty01 ~]# curl rrups.dookt.com.cn:10005</span><br><span class="line">9011 server respomse.</span><br><span class="line">[root@openresty01 ~]# curl rrups.dookt.com.cn:10005</span><br><span class="line">9012 server respomse.</span><br><span class="line">[root@openresty01 ~]# curl rrups.dookt.com.cn:10005</span><br><span class="line">9011 server respomse.</span><br><span class="line">[root@openresty01 ~]# curl rrups.dookt.com.cn:10005</span><br><span class="line">9011 server respomse.</span><br><span class="line">[root@openresty01 ~]# curl rrups.dookt.com.cn:10005</span><br><span class="line">9012 server respomse.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">通过tcpdump抓包分析，</span></span><br><span class="line">[root@openresty01 ~]# curl rrups.dookt.com.cn:10005       #向9011发送报文</span><br><span class="line">9011 server respomse.</span><br><span class="line">[root@openresty01 ~]# curl rrups.dookt.com.cn:10005</span><br><span class="line">9012 server respomse.</span><br><span class="line">[root@openresty01 ~]# curl rrups.dookt.com.cn:10005       #向9011发送报文</span><br><span class="line">9011 server respomse.</span><br><span class="line">[root@openresty01 ~]# tcpdump -i lo port 9011     #这几次访问都没有关闭连接</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:10:00.679067 IP localhost.33782 &gt; localhost.9011: Flags [S], seq 1377635386, win 43690, options [mss 65495,sackOK,TS val 25658580 ecr 0,nop,wscale 7], length 0</span><br><span class="line">19:52:42.147817 IP localhost.9011 &gt; localhost.33782: Flags [S.], seq 1262964724, ack 1377635387, win 43690, options [mss 65495,sackOK,TS val 25658580 ecr 25658580,nop,wscale 7], length 0</span><br><span class="line">16:10:00.679119 IP localhost.33782 &gt; localhost.9011: Flags [.], ack 1, win 342, options [nop,nop,TS val 25658580 ecr 25658580], length 0</span><br><span class="line">16:10:00.679164 IP localhost.33782 &gt; localhost.9011: Flags [P.], seq 1:89, ack 1, win 342, options [nop,nop,TS val 25658580 ecr 25658580], length 88</span><br><span class="line">16:10:00.679169 IP localhost.9011 &gt; localhost.33782: Flags [.], ack 89, win 342, options [nop,nop,TS val 25658580 ecr 25658580], length 0</span><br><span class="line">16:10:00.679253 IP localhost.9011 &gt; localhost.33782: Flags [P.], seq 1:172, ack 89, win 342, options [nop,nop,TS val 25658580 ecr 25658580], length 171</span><br><span class="line">16:10:00.679256 IP localhost.33782 &gt; localhost.9011: Flags [.], ack 172, win 350, options [nop,nop,TS val 25658580 ecr 25658580], length 0</span><br><span class="line">16:10:00.680745 IP localhost.9011 &gt; localhost.33782: Flags [F.], seq 172, ack 89, win 342, options [nop,nop,TS val 25658582 ecr 25658580], length 0</span><br><span class="line">16:10:00.681005 IP localhost.33782 &gt; localhost.9011: Flags [F.], seq 89, ack 173, win 350, options [nop,nop,TS val 25658582 ecr 25658582], length 0</span><br><span class="line">16:10:00.681019 IP localhost.9011 &gt; localhost.33782: Flags [.], ack 90, win 342, options [nop,nop,TS val 25658582 ecr 25658582], length 0</span><br><span class="line">16:10:19.678451 IP localhost.33786 &gt; localhost.9011: Flags [S], seq 1105788511, win 43690, options [mss 65495,sackOK,TS val 25677579 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:32:42.250471 IP localhost.9011 &gt; localhost.33786: Flags [S.], seq 1019653247, ack 1105788512, win 43690, options [mss 65495,sackOK,TS val 25677579 ecr 25677579,nop,wscale 7], length 0</span><br><span class="line">16:10:19.678458 IP localhost.33786 &gt; localhost.9011: Flags [.], ack 1, win 342, options [nop,nop,TS val 25677579 ecr 25677579], length 0</span><br><span class="line">16:10:19.678468 IP localhost.33786 &gt; localhost.9011: Flags [P.], seq 1:89, ack 1, win 342, options [nop,nop,TS val 25677579 ecr 25677579], length 88</span><br><span class="line">16:10:19.678470 IP localhost.9011 &gt; localhost.33786: Flags [.], ack 89, win 342, options [nop,nop,TS val 25677579 ecr 25677579], length 0</span><br><span class="line">16:10:19.678488 IP localhost.9011 &gt; localhost.33786: Flags [P.], seq 1:172, ack 89, win 342, options [nop,nop,TS val 25677579 ecr 25677579], length 171</span><br><span class="line">16:10:19.678489 IP localhost.33786 &gt; localhost.9011: Flags [.], ack 172, win 350, options [nop,nop,TS val 25677579 ecr 25677579], length 0</span><br><span class="line">16:10:19.678512 IP localhost.9011 &gt; localhost.33786: Flags [F.], seq 172, ack 89, win 342, options [nop,nop,TS val 25677579 ecr 25677579], length 0</span><br><span class="line">16:10:19.678530 IP localhost.33786 &gt; localhost.9011: Flags [F.], seq 89, ack 173, win 350, options [nop,nop,TS val 25677579 ecr 25677579], length 0</span><br><span class="line">16:10:19.678532 IP localhost.9011 &gt; localhost.33786: Flags [.], ack 90, win 342, options [nop,nop,TS val 25677579 ecr 25677579], length 0</span><br></pre></td></tr></table></figure>

<h3 id="负载均衡算法：ip-hash与hash模块"><a href="#负载均衡算法：ip-hash与hash模块" class="headerlink" title="负载均衡算法：ip_hash与hash模块"></a>负载均衡算法：ip_hash与hash模块</h3><h4 id="基于客户端IP地址的hash算法实现负载均衡：upstream-ip-hash模块"><a href="#基于客户端IP地址的hash算法实现负载均衡：upstream-ip-hash模块" class="headerlink" title="基于客户端IP地址的hash算法实现负载均衡：upstream_ip_hash模块"></a>基于客户端IP地址的hash算法实现负载均衡：upstream_ip_hash模块</h4><ul>
<li>功能：以客户端IP地址作为hash算法的关键字，映射到特定的上游服务器中<ul>
<li>对IPv4地址使用前3个字节作为关键字，对于IPv6则使用完整地址</li>
<li>可以使用realip模块修改用于执行算法的IP地址</li>
</ul>
</li>
<li>模块：ngx_http_upstream_ip_hash_module，默认编译，通过–without-http_upstream_ip_hash_module禁用模块</li>
<li>语法</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>ip_hash;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>upstream</code></td>
</tr>
</tbody></table>
<h4 id="基于关键字查找实现hash算法的负载均衡：upstream-hash模块"><a href="#基于关键字查找实现hash算法的负载均衡：upstream-hash模块" class="headerlink" title="基于关键字查找实现hash算法的负载均衡：upstream_hash模块"></a>基于关键字查找实现hash算法的负载均衡：upstream_hash模块</h4><ul>
<li>功能：通过指定关键字作为hash key，基于hash算法映射特定的上游服务器中<ul>
<li>关键字可以含有变量字符串</li>
</ul>
</li>
<li>模块：ngx_http_upstream_hash_module，默认编译，通过–without-http_upstream_hash_module禁用模块</li>
<li>语法：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>hash <em>key</em> [consistent];</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>upstream</code></td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream iphashups &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 127.0.0.1:9011 weight=2 max_conns=2 max_fails=2 fail_timeout=5;    </span><br><span class="line">    server 127.0.0.1:9012;   #此时weight不生效,因为使用了ip_hash，必须根据用户IP地址来确定</span><br><span class="line">    #keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    set_real_ip_from 172.16.100.11;      #为了方便测试，使用了realip模块。设置可信地址是本机地址</span><br><span class="line">    real_ip_recursive on;</span><br><span class="line">    real_ip_header X-Forwarded-For;  #从X-Forwarded-For的最后一个地址中拿出来作为IP地址即$remote_addr</span><br><span class="line">    listen 10005;</span><br><span class="line">    server_name iphash.dookt.com.cn;</span><br><span class="line">    error_log logs/rrups-error.log info;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://iphashups;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connention "";</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用curl -H 在header头部添加上X-Forwarded-For的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">测试结果如下：通过不同IP地址访问到的后端服务不一样，但是同一个IP访问到的肯定是同一个后端服务</span></span><br><span class="line">[root@openresty01 ~]# curl -H 'X-Forwarded-For: 100.200.20.200' iphash.dookt.com.cn:10005</span><br><span class="line">9012 server respomse.</span><br><span class="line">[root@openresty01 ~]# curl -H 'X-Forwarded-For: 172.15.54.1' iphash.dookt.com.cn:10005 </span><br><span class="line">9011 server respomse.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">upstream iphashups &#123;</span><br><span class="line">    hash user_$arg_username;</span><br><span class="line">    server 127.0.0.1:9011 weight=2 max_conns=2 max_fails=2 fail_timeout=5;</span><br><span class="line">    server 127.0.0.1:9012;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    set_real_ip_from 172.16.100.11;</span><br><span class="line">    real_ip_recursive on;</span><br><span class="line">    real_ip_header X-Forwarded-For;</span><br><span class="line">    listen 10005;</span><br><span class="line">    server_name iphash.dookt.com.cn;</span><br><span class="line">    error_log logs/rrups-error.log info;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://iphashups;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connention "";</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">以下结果发现，通过访问不同的username到的后端服务不一样，但是同一个username访问过去的肯定是同一个后端服务</span></span><br><span class="line">[root@openresty01 ~]# curl -H 'X-Forwarded-For: 100.200.20.200' iphash.dookt.com.cn:10005?username=389446587asdf</span><br><span class="line">9011 server respomse.</span><br><span class="line">[root@openresty01 ~]# curl -H 'X-Forwarded-For: 100.200.20.200' iphash.dookt.com.cn:10005?username=2346sfs57asdfgag   </span><br><span class="line">9012 server respomse.</span><br></pre></td></tr></table></figure>

<h3 id="一致性hash算法"><a href="#一致性hash算法" class="headerlink" title="一致性hash算法"></a>一致性hash算法</h3><h4 id="hash算法的问题"><a href="#hash算法的问题" class="headerlink" title="hash算法的问题"></a>hash算法的问题</h4><p>举例，设置选中上游server的算法为：key % 5</p>
<ul>
<li><p>key5 &lt;—&gt;  server0</p>
</li>
<li><p>key6 &lt;—&gt;  server1</p>
</li>
<li><p>key7 &lt;—&gt;  server2</p>
</li>
<li><p>key8 &lt;—&gt;  server3</p>
</li>
<li><p>key9 &lt;—&gt;  server4</p>
</li>
</ul>
<p>此时如果一台server4宕机。则所有策略都会改变</p>
<ul>
<li>key5 &lt;—&gt;  server1</li>
<li>key6 &lt;—&gt;  server2</li>
<li>key7 &lt;—&gt;  server3</li>
<li>key8 &lt;—&gt;  server0</li>
<li>key9 &lt;—&gt;  server1</li>
</ul>
<p>所以，宕机或者扩容时，hash算法会引发大量的路由变更，可能导致缓存大范围失效</p>
<p>一致性hash算法，缓解hash算法的的扩容或宕机引发的路由变更，导致缓存大范围失效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream ipchashups &#123;</span><br><span class="line">    ip_hash consistent;        #一致性hash配置只需要在ip_hash上添加consistent即可</span><br><span class="line">    server 127.0.0.1:9011 weight=2 max_conns=2 max_fails=2 fail_timeout=5;    </span><br><span class="line">    server 127.0.0.1:9012;   #此时weight不生效,因为使用了ip_hash，必须根据用户IP地址来确定</span><br><span class="line">    #keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    set_real_ip_from 172.16.100.11;      #为了方便测试，使用了realip模块。设置可信地址是本机地址</span><br><span class="line">    real_ip_recursive on;</span><br><span class="line">    real_ip_header X-Forwarded-For;  #从X-Forwarded-For的最后一个地址中拿出来作为IP地址即$remote_addr</span><br><span class="line">    listen 10005;</span><br><span class="line">    server_name ipchash.dookt.com.cn;</span><br><span class="line">    error_log logs/rrups-error.log info;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://ipchashups;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connention "";</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="最少连接算法以及如何跨worker进程生效"><a href="#最少连接算法以及如何跨worker进程生效" class="headerlink" title="最少连接算法以及如何跨worker进程生效"></a>最少连接算法以及如何跨worker进程生效</h3><h4 id="优先选择连接最少的上游服务：upstream-least-conn模块"><a href="#优先选择连接最少的上游服务：upstream-least-conn模块" class="headerlink" title="优先选择连接最少的上游服务：upstream_least_conn模块"></a>优先选择连接最少的上游服务：upstream_least_conn模块</h4><ul>
<li>功能：从所有服务器中，找出当前并发连接数最少的一个，将请求转发到它。<ul>
<li>如果出现多个最小连接数一样的，使用round-robin算法</li>
</ul>
</li>
<li>模块：ngx_http_upstream_least_conn_module，通过–without-http_upstream_ip_hash_module禁用模块</li>
<li>语法：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>least_conn;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>upstream</code></td>
</tr>
</tbody></table>
<h4 id="使用共享内存使负载均衡策略对所有worker进程生效：upstream-zone模块"><a href="#使用共享内存使负载均衡策略对所有worker进程生效：upstream-zone模块" class="headerlink" title="使用共享内存使负载均衡策略对所有worker进程生效：upstream_zone模块"></a>使用共享内存使负载均衡策略对所有worker进程生效：upstream_zone模块</h4><ul>
<li>功能：分配出共享内存，将其他upstream模块定义的负载均衡数据、运行是每个上上游服务的状态数据存放到共享内存上，以对所有nginx的worker进程都生效</li>
<li>模块：ngx_http_upstream_zone_module，默认编译。通过–without-http_upstream_zone_module禁用该模块</li>
<li>语法：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>zone <em>name</em> [size];</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>upstream</code></td>
</tr>
</tbody></table>
<h3 id="upstream模块提供的变量"><a href="#upstream模块提供的变量" class="headerlink" title="upstream模块提供的变量"></a>upstream模块提供的变量</h3><h4 id="不含cache的upstream提供的变量"><a href="#不含cache的upstream提供的变量" class="headerlink" title="不含cache的upstream提供的变量"></a>不含cache的upstream提供的变量</h4><ul>
<li>upstream_addr：上游服务的IP地址，格式为可读字符串，例如：127.0.0.1:9011</li>
<li>upstream_connect_time：与上游服务连接消耗的时间，单位为秒，精确到毫秒</li>
<li>upstream_header_time：接收上游服务发回响应中http头部所消耗的时间，单位为秒，精确到毫秒</li>
<li>upstream_response_time：接收完整上游服务响应所消耗的时间，单位为秒吗，精确到毫秒</li>
<li>upstream_http_名称：从上游服务返回的响应头部的值</li>
<li>upstream_bytes_received：从上游服务接收到的响应长度，单位为字节</li>
<li>upstream_response_length：从上游服务返回响应包体的长度，单位为字节</li>
<li>upstream_status：上游服务返回的HTTP响应中的状态码。如果未连接上，该变量值为502</li>
<li>upstream_cookies_名称：从上游服务发回响应头Set-Cookies中取出的cookie的值</li>
<li>upstream_trailer_名称：从上游服务尾部取到的值</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">upstream varups &#123;</span><br><span class="line">    server 127.0.0.1:9011 weight=2 max_conns=2 max_fails=2 fail_timeout=5;</span><br><span class="line">    server 127.0.0.1:9012;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">log_format varups '$upstream_addr $upstream_connect_time $upstream_header_time $upstream_response_time '</span><br><span class="line">                    '$upstream_response_length $upstream_bytes_received '</span><br><span class="line">                    '$upstream_status $upstream_http_server $upstream_cache_status';</span><br><span class="line">server &#123;</span><br><span class="line">    set_real_ip_from 172.16.100.11;</span><br><span class="line">    real_ip_recursive on;</span><br><span class="line">    real_ip_header X-Forwarded-For;</span><br><span class="line">    listen 10005;</span><br><span class="line">    server_name varups.dookt.com.cn;</span><br><span class="line">    error_log logs/upstream-error.log info;</span><br><span class="line">    access_log logs/upstream-access.log varups;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://varups;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connention "";</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="proxy模块处理请求的流程"><a href="#proxy模块处理请求的流程" class="headerlink" title="proxy模块处理请求的流程"></a>proxy模块处理请求的流程</h3><h4 id="对HTTP协议的反向代理：proxy模块"><a href="#对HTTP协议的反向代理：proxy模块" class="headerlink" title="对HTTP协议的反向代理：proxy模块"></a>对HTTP协议的反向代理：proxy模块</h4><ul>
<li>功能：对上游服务使用http/https协议进行反向代理</li>
<li>模块：ngx_http_proxy_module，默认编译，使用–without-http_proxy_module禁用模块</li>
<li>语法：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>proxy_pass URL;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>location</code>, <code>if in location</code>, <code>limit_except</code></td>
</tr>
</tbody></table>
<ul>
<li>URL参数规则：<ul>
<li>URL必须以 http:// 或 https:// 开头，接下来是域名、IP、unix socket地址或者upstream的名字。前两者可以在域名或者IP后加端口。域名和IP后面的URI是可选的。</li>
<li>URL参数中是否携带了URI，会导致发向上游请求的URL不同：<ul>
<li>不携带URI，客户端请求中的URL直接转发给上游<ul>
<li>location 后使用正则表达式、@名字时，应采用这种方式</li>
</ul>
</li>
<li>携带URI，则对用户请求中的URL做如下操作：<ul>
<li>将location参数中匹配上的一段替换为该URL</li>
</ul>
</li>
</ul>
</li>
<li>该URL参数可以携带变量</li>
<li>更复杂的URL替换，可以在location内的配置添加rewrite break语句</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> upserver.conf配置</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 9012;</span><br><span class="line">    default_type text/plain;</span><br><span class="line">    return 200 '9012 server respomse.</span><br><span class="line">uri: $uri\n';</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置1，proxy_pass指令没有携带URI</span></span><br><span class="line">upstream proxyups &#123;</span><br><span class="line">    server 127.0.0.1:9012 weight=1;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 10006;</span><br><span class="line">    server_name  proxy.dookt.com.cn;</span><br><span class="line">    error_log logs/proxy-error.log info;</span><br><span class="line">    access_log logs/proxy-access.log;</span><br><span class="line"></span><br><span class="line">    location /a &#123;</span><br><span class="line">        proxy_pass http://proxyups;        #没有携带URI</span><br><span class="line">        #proxy_mothod POST;</span><br><span class="line">        proxy_pass_request_headers off;</span><br><span class="line">        #proxy_pass_request_body off;</span><br><span class="line">        proxy_set_body 'hello world!';</span><br><span class="line">        proxy_set_header name '';</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection "";</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置2，proxy_pass指令携带URI</span></span><br><span class="line">upstream proxyups &#123;</span><br><span class="line">    server 127.0.0.1:9012 weight=1;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 10006;</span><br><span class="line">    server_name  proxy.dookt.com.cn;</span><br><span class="line">    error_log logs/proxy-error.log info;</span><br><span class="line">    access_log logs/proxy-access.log;</span><br><span class="line"></span><br><span class="line">    location /a &#123;</span><br><span class="line">        proxy_pass http://proxyups/www;        #携带URI /www</span><br><span class="line">        #proxy_mothod POST;</span><br><span class="line">        proxy_pass_request_headers off;</span><br><span class="line">        #proxy_pass_request_body off;</span><br><span class="line">        proxy_set_body 'hello world!';</span><br><span class="line">        proxy_set_header name '';</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection "";</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">分别访问配置1 和 2，结果如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">未携带uri</span></span><br><span class="line">[root@openresty01 ~]# curl proxy.dookt.com.cn:10006/a/b/c</span><br><span class="line">9012 server respomse.</span><br><span class="line">uri: /a/b/c                  #proxy_pass未携带URI,客户端请求中的URL（/a/b/c）直接转发给上游</span><br><span class="line"><span class="meta">#</span><span class="bash">携带uri</span></span><br><span class="line">[root@openresty01 ~]# curl proxy.dookt.com.cn:10006/a/b/c</span><br><span class="line">9012 server respomse.</span><br><span class="line">uri: /www/b/c                #proxy_pass携带URI,将location参数中匹配上的一段替换为该URL</span><br></pre></td></tr></table></figure>

<h3 id="根据指令修改发往上游的请求"><a href="#根据指令修改发往上游的请求" class="headerlink" title="根据指令修改发往上游的请求"></a>根据指令修改发往上游的请求</h3><h4 id="生成发往上游的请求行"><a href="#生成发往上游的请求行" class="headerlink" title="生成发往上游的请求行"></a>生成发往上游的请求行</h4><table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>proxy_method method;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code>, <code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>proxy_http_version 1.0 | 1.1;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td><code>proxy_http_version 1.0;</code></td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code>, <code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<h4 id="生成发往上游的请求头"><a href="#生成发往上游的请求头" class="headerlink" title="生成发往上游的请求头"></a>生成发往上游的请求头</h4><p>若value的值为空字符串，这整个header都不会向上游发送</p>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>proxy_set_header field value;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>proxy_set_header Host $proxy_host;``proxy_set_header Connection close;</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code>, <code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>proxy_pass_request_headers on | off;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>proxy_pass_request_headers on;</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code>, <code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>proxy_pass_request_body on | off;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>proxy_pass_request_body on;</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code>, <code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th>proxy_set_body value;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code>, <code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">配置1，默认配置，传递header,没有设置header和body</span></span><br><span class="line">upstream proxyups &#123;</span><br><span class="line">    server 127.0.0.1:9012 weight=1;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 10006;</span><br><span class="line">    server_name  proxy.dookt.com.cn;</span><br><span class="line">    error_log logs/proxy-error.log info;</span><br><span class="line">    access_log logs/proxy-access.log;</span><br><span class="line">    location /a &#123;</span><br><span class="line">        proxy_pass http://proxyups/www;</span><br><span class="line">        #proxy_mothod POST;</span><br><span class="line">        #proxy_pass_request_headers off;</span><br><span class="line">        #proxy_pass_request_body off;</span><br><span class="line">        #proxy_set_body 'hello world!';</span><br><span class="line">        #proxy_set_header name '';</span><br><span class="line">        #proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection "";</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置2，不传递header,修改方法为POST</span></span><br><span class="line">    location /a &#123;</span><br><span class="line">        proxy_pass http://proxyups/www;</span><br><span class="line">        proxy_method POST;</span><br><span class="line">        proxy_pass_request_headers off;</span><br><span class="line">        #proxy_pass_request_body off;</span><br><span class="line">        #proxy_set_body 'hello world!';</span><br><span class="line">        #proxy_set_header name '';</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection "";</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置3，设置body</span></span><br><span class="line">    location /a &#123;</span><br><span class="line">        proxy_pass http://proxyups/www;</span><br><span class="line">        proxy_method POST;</span><br><span class="line">        proxy_pass_request_headers off;</span><br><span class="line">        #proxy_pass_request_body off;</span><br><span class="line">        proxy_set_body 'hello world!';</span><br><span class="line">        proxy_set_header name '';</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection "";</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">配置1，默认开启传递header，所以httpname为myname, 方法为get,协议为1.0</span></span><br><span class="line">[root@openresty01 ~]# curl -H "name: myname" proxy.dookt.com.cn:10006/a</span><br><span class="line">9012 server respomse.</span><br><span class="line">uri: /www</span><br><span class="line">method: GET</span><br><span class="line">request: GET /www HTTP/1.0</span><br><span class="line">httpname: myname</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置2，不传递header，httpname为空，方法为post，协议为1.1</span></span><br><span class="line">[root@openresty01 ~]# curl -H "name: myname" proxy.dookt.com.cn:10006/a</span><br><span class="line">9012 server respomse.</span><br><span class="line">uri: /www</span><br><span class="line">method: POST</span><br><span class="line">request: POST /www HTTP/1.1</span><br><span class="line">httpname: </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置3，header设置为空，传递过去取到的还是空（httpname: ）</span></span><br><span class="line">[root@openresty01 ~]# tcpdump -i lo port 9012 -A -s 0     #通过抓包查看body已经传入了hello world!</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">04:51:58.894007 IP localhost.44716 &gt; localhost.9012: Flags [S], seq 2280917651, win 43690, options [mss 65495,sackOK,TS val 71376795 ecr 0,nop,wscale 7], length 0</span><br><span class="line">E..&lt;..@.@.'...........#4..</span><br><span class="line">..........0.........</span><br><span class="line">.A..........</span><br><span class="line">11:50:03.167884 IP localhost.9012 &gt; localhost.44716: Flags [S.], seq 1393064595, ack 2280917652, win 43690, options [mss 65495,sackOK,TS val 71376795 ecr 71376795,nop,wscale 7], length 0</span><br><span class="line">E..&lt;..@.@.&lt;.........#4..S.z...</span><br><span class="line">......0.........</span><br><span class="line">.A...A......</span><br><span class="line">04:51:58.894015 IP localhost.44716 &gt; localhost.9012: Flags [.], ack 1, win 342, options [nop,nop,TS val 71376795 ecr 71376795], length 0</span><br><span class="line">E..4.   @.@.'...........#4..</span><br><span class="line">.S.z....V.(.....</span><br><span class="line">.A...A..</span><br><span class="line">04:51:58.894024 IP localhost.44716 &gt; localhost.9012: Flags [P.], seq 1:71, ack 1, win 342, options [nop,nop,TS val 71376795 ecr 71376795], length 70</span><br><span class="line">E..z.</span><br><span class="line">@.@.'r..........#4..</span><br><span class="line">.S.z....V.n.....</span><br><span class="line">.A...A..POST /www HTTP/1.1</span><br><span class="line">Host: proxyups</span><br><span class="line">Content-Length: 12</span><br><span class="line"></span><br><span class="line">hello world!</span><br><span class="line">04:51:58.894026 IP localhost.9012 &gt; localhost.44716: Flags [.], ack 71, win 342, options [nop,nop,TS val 71376795 ecr 71376795], length 0</span><br><span class="line">E..4e.@.@...........#4..S.z...</span><br><span class="line">....V.(.....</span><br><span class="line">.A...A..</span><br><span class="line">04:51:58.894045 IP localhost.9012 &gt; localhost.44716: Flags [P.], seq 1:240, ack 71, win 342, options [nop,nop,TS val 71376795 ecr 71376795], length 239</span><br><span class="line">E..#e.@.@...........#4..S.z...</span><br><span class="line">....V.......</span><br><span class="line">.A...A..HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.13.6.2</span><br><span class="line">Date: Sun, 14 Jul 2019 20:51:58 GMT</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Content-Length: 85</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">9012 server respomse.</span><br><span class="line">uri: /www</span><br><span class="line">method: POST</span><br><span class="line">request: POST /www HTTP/1.1</span><br><span class="line">httpname: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">04:51:58.894047 IP localhost.44716 &gt; localhost.9012: Flags [.], ack 240, win 350, options [nop,nop,TS val 71376795 ecr 71376795], length 0</span><br><span class="line">E..4..@.@.'...........#4..</span><br><span class="line">.S.&#123;....^.(.....</span><br><span class="line">.A...A..</span><br><span class="line">04:51:58.894082 IP localhost.44716 &gt; localhost.9012: Flags [F.], seq 71, ack 240, win 350, options [nop,nop,TS val 71376795 ecr 71376795], length 0</span><br><span class="line">E..4..@.@.'...........#4..</span><br><span class="line">.S.&#123;....^.(.....</span><br><span class="line">.A...A..</span><br><span class="line">04:51:58.894101 IP localhost.9012 &gt; localhost.44716: Flags [F.], seq 240, ack 72, win 342, options [nop,nop,TS val 71376795 ecr 71376795], length 0</span><br><span class="line">E..4e.@.@...........#4..S.&#123;...</span><br><span class="line">....V.(.....</span><br><span class="line">.A...A..</span><br><span class="line">04:51:58.894103 IP localhost.44716 &gt; localhost.9012: Flags [.], ack 241, win 350, options [nop,nop,TS val 71376795 ecr 71376795], length 0</span><br><span class="line">E..4..@.@.'...........#4..</span><br><span class="line">.S.&#123;....^.(.....</span><br><span class="line">.A...A..</span><br></pre></td></tr></table></figure>

<h3 id="接收用户请求的包体"><a href="#接收用户请求的包体" class="headerlink" title="接收用户请求的包体"></a>接收用户请求的包体</h3></div><div class="post-copyright"><blockquote><p>原文作者: Mr.Chen</p><p>原文链接: <a href="http://www.dookt.com/post/6325.html">http://www.dookt.com/post/6325.html</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"><a href="/tags/Nginx/">Nginx</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/post/47516.html" class="pre">Nginx-架构基础</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx反向代理与负载均衡"><span class="toc-text">Nginx反向代理与负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#负载均衡"><span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx在AKF扩展立方体的应用"><span class="toc-text">Nginx在AKF扩展立方体的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#负载均衡策略：round-robin"><span class="toc-text">负载均衡策略：round-robin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#指定上游服务地址的upstream与server指令"><span class="toc-text">指定上游服务地址的upstream与server指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加权Round-Robin负载均衡算法"><span class="toc-text">加权Round-Robin负载均衡算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对上游服务使用keepalived长连接"><span class="toc-text">对上游服务使用keepalived长连接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#upstream-keepalive的指令"><span class="toc-text">upstream_keepalive的指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#指定上游服务域名解析的resolver指令"><span class="toc-text">指定上游服务域名解析的resolver指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#负载均衡算法：ip-hash与hash模块"><span class="toc-text">负载均衡算法：ip_hash与hash模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基于客户端IP地址的hash算法实现负载均衡：upstream-ip-hash模块"><span class="toc-text">基于客户端IP地址的hash算法实现负载均衡：upstream_ip_hash模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于关键字查找实现hash算法的负载均衡：upstream-hash模块"><span class="toc-text">基于关键字查找实现hash算法的负载均衡：upstream_hash模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一致性hash算法"><span class="toc-text">一致性hash算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hash算法的问题"><span class="toc-text">hash算法的问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最少连接算法以及如何跨worker进程生效"><span class="toc-text">最少连接算法以及如何跨worker进程生效</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#优先选择连接最少的上游服务：upstream-least-conn模块"><span class="toc-text">优先选择连接最少的上游服务：upstream_least_conn模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用共享内存使负载均衡策略对所有worker进程生效：upstream-zone模块"><span class="toc-text">使用共享内存使负载均衡策略对所有worker进程生效：upstream_zone模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upstream模块提供的变量"><span class="toc-text">upstream模块提供的变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#不含cache的upstream提供的变量"><span class="toc-text">不含cache的upstream提供的变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy模块处理请求的流程"><span class="toc-text">proxy模块处理请求的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#对HTTP协议的反向代理：proxy模块"><span class="toc-text">对HTTP协议的反向代理：proxy模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#根据指令修改发往上游的请求"><span class="toc-text">根据指令修改发往上游的请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#生成发往上游的请求行"><span class="toc-text">生成发往上游的请求行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成发往上游的请求头"><span class="toc-text">生成发往上游的请求头</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接收用户请求的包体"><span class="toc-text">接收用户请求的包体</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/post/c6b0c30c.html">Nginx设置为系统服务</a></li><li class="post-list-item"><a class="post-list-link" href="/post/a2c1797d.html">Tomcat设置为系统服务</a></li><li class="post-list-item"><a class="post-list-link" href="/post/7df7e5a.html">Python编写zabbix告警邮件</a></li><li class="post-list-item"><a class="post-list-link" href="/post/4120479c.html">DockerFile生成镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/post/d936a15c.html">Jenkins发布脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/post/d6261197.html">k8s-一个简单的例子</a></li><li class="post-list-item"><a class="post-list-link" href="/post/41380.html">Mysql设置权限</a></li><li class="post-list-item"><a class="post-list-link" href="/post/11988.html">Docker实战</a></li><li class="post-list-item"><a class="post-list-link" href="/post/35152.html">Mycat+MySQL读写分离</a></li><li class="post-list-item"><a class="post-list-link" href="/post/59899.html">RAID简介</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Jenkins/">Jenkins</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8S/">K8S</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">31</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">10</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/FTP/" style="font-size: 15px;">FTP</a> <a href="/tags/系统管理/" style="font-size: 15px;">系统管理</a> <a href="/tags/高可用/" style="font-size: 15px;">高可用</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/Scripts/" style="font-size: 15px;">Scripts</a> <a href="/tags/Jenkins/" style="font-size: 15px;">Jenkins</a> <a href="/tags/虚拟化/" style="font-size: 15px;">虚拟化</a> <a href="/tags/Python基础/" style="font-size: 15px;">Python基础</a> <a href="/tags/Zabbix/" style="font-size: 15px;">Zabbix</a> <a href="/tags/监控/" style="font-size: 15px;">监控</a> <a href="/tags/磁盘管理/" style="font-size: 15px;">磁盘管理</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a> <a href="/tags/运维基本功/" style="font-size: 15px;">运维基本功</a> <a href="/tags/系统命令/" style="font-size: 15px;">系统命令</a> <a href="/tags/容器/" style="font-size: 15px;">容器</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://www.cnblogs.com/clsn" title="惨绿少年" target="_blank">惨绿少年</a><ul></ul><a href="http://www.zsythink.net/" title="朱双印博客" target="_blank">朱双印博客</a><ul></ul><a href="https://www.linuxba.com/" title="Linux吧" target="_blank">Linux吧</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Mr.Chen.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c6588ff9864e03b5fbcbba5a323ad966";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>