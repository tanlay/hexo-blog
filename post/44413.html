<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">
  <link rel="alternate" href="/atom.xml" title="MINT" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">

<link rel="stylesheet" href="//fonts.lug.ustc.edu.cn/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="随着企业网站访问量越来越大，服务器的压力也逐渐增加，主要体现在CPU使用率、内存、硬盘、网卡流量等方面资源占用情况很高。此时需对服务器性能进行调优，尽量在保持服务器的现有数量，然后对其各个环节参数进行优化。">
<meta name="keywords" content="运维基本功">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux性能优化企业实战">
<meta property="og:url" content="http://www.dookt.com/post/44413.html">
<meta property="og:site_name" content="MINT">
<meta property="og:description" content="随着企业网站访问量越来越大，服务器的压力也逐渐增加，主要体现在CPU使用率、内存、硬盘、网卡流量等方面资源占用情况很高。此时需对服务器性能进行调优，尽量在保持服务器的现有数量，然后对其各个环节参数进行优化。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-09-10T14:30:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux性能优化企业实战">
<meta name="twitter:description" content="随着企业网站访问量越来越大，服务器的压力也逐渐增加，主要体现在CPU使用率、内存、硬盘、网卡流量等方面资源占用情况很高。此时需对服务器性能进行调优，尽量在保持服务器的现有数量，然后对其各个环节参数进行优化。">
  <link rel="canonical" href="http://www.dookt.com/post/44413">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Linux性能优化企业实战 | MINT</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">MINT</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">感谢平庸与我随行!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://www.dookt.com/post/44413.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Chen">
      <meta itemprop="description" content="个人博客系统">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MINT">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Linux性能优化企业实战

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-07-26 20:51:48" itemprop="dateCreated datePublished" datetime="2019-07-26T20:51:48+08:00">2019-07-26</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-10 22:30:54" itemprop="dateModified" datetime="2019-09-10T22:30:54+08:00">2019-09-10</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>随着企业网站访问量越来越大，服务器的压力也逐渐增加，主要体现在CPU使用率、内存、硬盘、网卡流量等方面资源占用情况很高。此时需对服务器性能进行调优，尽量在保持服务器的现有数量，然后对其各个环节参数进行优化。</p>
<a id="more"></a>

<p>Linux企业级性能服务器优化、TCP/IP报文、TCP三次握手及四次断开、Linux内核深入优化、Linux内核故障解决方案及对Linux性能进行评估等。</p>
<h4 id="TCP-IP报文详解"><a href="#TCP-IP报文详解" class="headerlink" title="TCP/IP报文详解"></a>TCP/IP报文详解</h4><p>TCP/IP 定义了电子设备如何连入因特网，以及数据如何在它们之间传输的标准。协议采用了4层的层级结构，每一层都呼叫它的下一层所提供的协议来完成自己的需求。</p>
<p>TCP负责发现传输的问题，一有问题就发出信号，要求重新传输，直到所有数据安全正确地传输到目的地，而IP是给因特网的每台联网设备规定一个地址。TCP/IP 协议数据封装的过程包括：用户数据经过应用层协议封装后传递给传输层，传输层封装TCP头部，交给网络层，网络层封装IP头部后，再交给数据链路层，数据链路层封装Ethernet帧头和帧尾，交给物理层，物理层以比特流的形式将数据发送到物理线路上。</p>
<p>一般而言，不同的协议层对数据包有不同的称谓，数据包在传输层叫做段（segment），在网络层叫做数据报（datagram），在链路层叫做帧（frame）。数据封装成帧后发到传输介质上，到达目的主机后每层协议再剥掉相应的首部，最后将应用层数据交给应用程序处理，如图15-1所示：</p>
<p>优化Linux服务器，需要了解TCP协议相关信息，例如TCP/IP数据报文的内容及如何传输的。</p>
<p>IP数据包详解如下：</p>
<p>Source Port和Destination Port:分别占用16位，表示源端口号和目的端口号；用于区别主机中的不同进程，而IP地址是用来区分不同的主机的，源端口号和目的端口号配合上IP首部中的源IP地址和目的IP地址就能唯一的确定一个TCP连接；<br>Sequence Number:用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的的第一个数据字节在数据流中的序号；主要用来解决网络报乱序的问题；<br>Acknowledgment Number:32位确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应当是上次已成功收到数据字节序号加1。不过，只有当标志位中的ACK标志（下面介绍）为1时该确认序列号的字段才有效。主要用来解决不丢包的问题；<br>Offset:给出首部中32 bit字的数目，需要这个值是因为任选字段的长度是可变的。这个字段占4bit（最多能表示15个32bit的的字，即4*15=60个字节的首部长度），因此TCP最多有60字节的首部。然而，没有任选字段，正常的长度是20字节；<br>TCP Flags:TCP首部中有6个标志比特，它们中的多个可同时被设置为1，主要是用于操控TCP的状态机的，依次为URG，ACK，PSH，RST，SYN，FIN。每个标志位的意思如下：<br>URG：此标志表示TCP包的紧急指针域（后面马上就要说到）有效，用来保证TCP连接不被中断，并且督促中间层设备要尽快处理这些数据；<br>ACK：此标志表示应答域有效，就是说前面所说的TCP应答号将会包含在TCP数据包中；有两个取值：0和1，为1的时候表示应答域有效，反之为0；<br>PSH：这个标志位表示Push操作。所谓Push操作就是指在数据包到达接收端以后，立即传送给应用程序，而不是在缓冲区中排队；<br>RST：这个标志表示连接复位请求。用来复位那些产生错误的连接，也被用来拒绝错误和非法的数据包；<br>SYN：表示同步序号，用来建立连接。SYN标志位和ACK标志位搭配使用，当连接请求的时候，SYN=1，ACK=0；连接被响应的时候，SYN=1，ACK=1；这个标志的数据包经常被用来进行端口扫描。扫描者发送一个只有SYN的数据包，如果对方主机响应了一个数据包回来 ，就表明这台主机存在这个端口；但是由于这种扫描方式只是进行TCP三次握手的第一次握手，因此这种扫描的成功表示被扫描的机器不很安全，一台安全的主机将会强制要求一个连接严格的进行TCP的三次握手；<br>FIN： 表示发送端已经达到数据末尾，也就是说双方的数据传送完成，没有数据可以传送了，发送FIN标志位的TCP数据包后，连接将被断开。这个标志的数据包也经常被用于进行端口扫描。<br>Window:窗口大小，也就是有名的滑动窗口，用来进行流量控制；<br>TCP三次握手及四次断开<br>TCP是面向连接的，无论哪一方向另一方发送数据之前，都必须先在双方之间建立一条连接。在TCP/IP协议中，TCP协议提供可靠的连接服务，连接是通过三次握手进行初始化的。三次握手的目的是同步连接双方的序列号和确认号并交换TCP窗口大小信息。</p>
<h4 id="TCP三次握手原理："><a href="#TCP三次握手原理：" class="headerlink" title="TCP三次握手原理："></a>TCP三次握手原理：</h4><p>第一次握手：建立连接。客户端发送连接请求报文段，将SYN位置为1，Sequence Number为x；然后客户端进入SYN_SENT状态，等待服务器的确认；<br>第二次握手：服务器收到SYN报文段。服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置Acknowledgment Number为x+1(Sequence Number+1)；同时，自己自己还要发送SYN请求信息，将SYN位置为1，Sequence Number为y；服务器端将上述所有信息放到一个报文段（即SYN+ACK报文段）中，一并发送给客户端，此时服务器进入SYN_RECV状态；<br>第三次握手：客户端收到服务器的SYN+ACK报文段。然后将Acknowledgment Number设置为y+1，向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。<br>如图15-4所示为基于tcpdump抓取TCP/IP三次握手及数据包传输过程：</p>
<p>TCP四次挥手原理：<br>第一次挥手：主机A（可以使客户端，可以是服务器端），设置Sequence Number和Acknowledgment Number，向主机B发送一个FIN报文段；此时，主机A进入FIN_WAIT_1状态；这表示主机A没有数据要发送给主机B；<br>第二次挥手：主机B收到了主机A发送的FIN报文段，向主机A回一个ACK报文段，Acknowledgment Number为Sequence Number加1；主机A进入FIN_WAIT_2状态；主机B告诉主机A，我“同意”你的关闭请求；<br>第三次挥手：主机B向主机A发送FIN报文段，请求关闭连接，同时主机B进入LAST_ACK状态；<br>第四次挥手：主机A收到主机B发送的FIN报文段，向主机B发送ACK报文段，然后主机A进入TIME_WAIT状态；主机B收到主机A的ACK报文段以后，就关闭连接；此时，主机A等待2MSL后依然没有收到回复，则证明Server端已正常关闭，那好，主机A也可以关闭连接。<br>如图15-5所示为基于tcpdump抓取TCP/IP四次挥手及数据包传输过程：</p>
<h4 id="优化Linux文件打开最大数"><a href="#优化Linux文件打开最大数" class="headerlink" title="优化Linux文件打开最大数"></a>优化Linux文件打开最大数</h4><p>为了防止失控的进程破坏系统的性能，Unix和Linux会跟踪进程使用的大部分资源，并允许用户和系统管理员使用对进程的资源限制，例如控制某个进程打开的系统文件数、对某个用户打开系统进程数进行限制等，一般限制手段包括：软限制和硬限制。<br>软限制（soft limit）是内核实际执行的限制，任何进程都可以将软限制设置为任意小于等于对进程限制的硬限制的值，(noproc)最大线程数和(nofile)文件数；<br>硬限制（hard limit）是可以在任何时候任何进程中设置，但硬限制只能由超级用户修改。<br>Linux系统一切皆文件，对Linux进行各种操作，其实是对文件进行操作，文件可分为：普通文件、目录文件、链接文件和设备文件。而文件描述符（file descriptor）是内核为了高效管理已被打开的文件所创建的索引，其值一个非负整数（通常是小整数），用于指代被打开的文件，所有执行I/O操作的系统调用都通过文件描述符。<br>Linux系统默认已经打开的文件描述符包括：STDIN_FILENO 0表示标准输入、STDOUT_FILENO 1表示标准输出、STDERR_FILENO 2表示标准错误输出，默认打开一个新文件，它的文件描述符为3。<br>每个文件描述符与一个打开文件相对应，不同的文件描述符可以指向同一个文件。相同的文件可以被不同的进程打开，也可以在同一个进程中被多次打开。<br>Linux系统为每个进程维护了一个文件描述符表，该表的值都从0开始的，在不同的进程中你会看到相同的文件描述符，相同文件描述符有可能指向同一个文件，也有可能指向不同的文件。Linux内核对文件操作，维护了3个数据结构概念如下：<br>进程级的文件描述符表；<br>系统级的打开文件描述符表；<br>文件系统的i-node表；<br>其中进程级的描述符表的每一个条目记录了单个文件描述符的相关信息，例如控制文件描述符操作的一组标志及对打开文件句柄的引用。Linux内核对所有打开的文件都维护了一个系统级的描述符表（open file description table）。将描述符表中的记录行称为打开文件句柄（open file handle），一个打开文件句柄存储了与一个打开文件相关的全部信息，详细信息如下：<br>当前文件偏移量；<br>打开文件时所使用的状态标识；<br>文件访问模式；<br>与信号驱动相关的设置；<br>对该文件i-node对象的引用；<br>文件类型和访问权限；<br>指针，指向该文件所持有的锁列表；<br>文件的各种属性。<br>默认Linux内核对每个用户设置了打开文件最大数为1024，对于高并发网站，是远远不够的，需要将默认值调整到更大，调整方法有两种：<br>Linux每个用户打开文件最大数临时设置方法，重启服务器该参数无效，命令行终端执行如下命令：<br>ulimit   -n  65535<br>Linux每个用户打开文件最大数永久设置方法，将如下代码加入内核限制文件/etc/security/limits.conf的末尾：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*    soft        noproc                  65535</span><br><span class="line">*    hard       noproc                  65535</span><br><span class="line">*    soft        nofile                    65535</span><br><span class="line">*    hard       nofile                    65535</span><br></pre></td></tr></table></figure>

<p>如上设置为对每个用户分别设置nofile、noproc最大数，如果需要对Linux整个系统设置文件最大数限制，需要修改/proc/sys/fs/file-max中的值，该值为Linux总文件打开数，例如设置为：echo 3865161233 &gt;/proc/sys/fs/file-max。</p>
<p>内核参数的优化<br>Linux /proc/sys目录下存放着多数内核的参数，并且可以在系统运行时进行更改，一般重新启动机器就会失效。而/etc/sysctl.conf是一个允许改变正在运行中的Linux系统的接口，它包含一些TCP/IP堆栈和虚拟内存系统的高级选项，修改内核参数永久生效。</p>
<p>/proc/sys下内核文件与配置文件sysctl.conf中变量存在着对应关系，即修改sysct.conf配置文件，其实是修改/proc/sys相关参数，所以对Linux内核优化只需修改/etc/sysctl.conf文件即可。如下为BAT企业生产环境/etc/sysct.conf内核完整参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 0</span><br><span class="line">net.ipv4.conf.default.rp_filter = 1</span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line">kernel.sysrq = 0</span><br><span class="line">kernel.core_uses_pid = 1</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line">kernel.shmmax = 68719476736</span><br><span class="line">kernel.shmall = 4294967296</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 10000</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 4194304</span><br><span class="line">net.ipv4.tcp_wmem = 4096 16384 4194304</span><br><span class="line">net.core.wmem_default = 8388608</span><br><span class="line">net.core.rmem_default = 8388608</span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line">net.core.wmem_max = 16777216</span><br><span class="line">net.core.netdev_max_backlog = 262144</span><br><span class="line">net.core.somaxconn = 262144</span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_mem = 94500000 915000000 927000000</span><br><span class="line">net.ipv4.tcp_fin_timeout = 1</span><br><span class="line">net.ipv4.tcp_keepalive_time = 30</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65535</span><br></pre></td></tr></table></figure>

<h4 id="Linux内核常见参数详解："><a href="#Linux内核常见参数详解：" class="headerlink" title="Linux内核常见参数详解："></a>Linux内核常见参数详解：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_timestamps = 1</span><br><span class="line">该参数控制RFC 1323 时间戳与窗口缩放选项；</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line">选择性应答(SACK)是 TCP 的一项可选特性,可以提高某些网络中所有可用带宽的使用效率；</span><br><span class="line">net.ipv4.tcp_fack = 1</span><br><span class="line">打开FACK(Forward ACK) 拥塞避免和快速重传功能；</span><br><span class="line">net.ipv4.tcp_retrans_collapse = 1</span><br><span class="line">打开重传重组包功能，为0的时候关闭重传重组包功能；</span><br><span class="line">net.ipv4.tcp_syn_retries = 5</span><br><span class="line">对于一个新建连接，内核要发送多少个SYN 连接请求才决定放弃；</span><br><span class="line">net.ipv4.tcp_synack_retries = 5</span><br><span class="line">tcp_synack_retries显示或设定Linux在回应SYN要求时尝试多少次重新发送初始SYN,ACK封包后才决定放弃；</span><br><span class="line">net.ipv4.tcp_max_orphans = 131072</span><br><span class="line">系统所能处理不属于任何进程的TCP sockets最大数量；</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line">系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息；</span><br><span class="line">默认为180000，设为较小数值此项参数可以控制TIME_WAIT套接字的最大数量，避免服务器被大量的TIME_WAIT套接字拖死；</span><br><span class="line">net.ipv4.tcp_keepalive_time = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 3</span><br><span class="line">如果某个TCP连接在空闲30秒后,内核才发起probe(探查)；</span><br><span class="line">如果probe 3次(每次3秒既tcp_keepalive_intvl值)不成功,内核才彻底放弃,认为该连接已失效；</span><br><span class="line">net.ipv4.tcp_retries1 = 3</span><br><span class="line">放弃回应一个TCP 连接请求前﹐需要进行多少次重试；</span><br><span class="line">net.ipv4.tcp_retries2 = 15</span><br><span class="line">在丢弃激活(已建立通讯状况)的TCP连接之前﹐需要进行多少次重试；</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">表示如果套接字由本端要求关闭，这个参数决定了它保持在 FIN-WAIT-2状态的时间；</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭；</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line">表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数；</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">TCP建立连接的 3 次握手过程中，当服务端收到最初的 SYN 请求时，会检查应用程序的syn_backlog队列是否已满，启用syncookie，可以解决超高并发时的Can’t  Connect` 问题。但是会导致 TIME_WAIT 状态fallback为保持2MSL时间，高峰期时会导致客户端无可复用连接而无法连接服务器；</span><br><span class="line">net.ipv4.tcp_orphan_retries = 0</span><br><span class="line">关闭TCP连接之前重试多少次；</span><br><span class="line">net.ipv4.tcp_mem = 178368  237824     356736</span><br><span class="line">net.ipv4.tcp_mem[0]: 低于此值,TCP没有内存压力；</span><br><span class="line">net.ipv4.tcp_mem[1]: 在此值下,进入内存压力阶段；</span><br><span class="line">net.ipv4.tcp_mem[2]: 高于此值,TCP拒绝分配socket；</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">表示开启重用，允许将TIME-WAIT sockets重新用于新的TCP连接；</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000</span><br><span class="line">表示用于向外连接的端口范围；</span><br><span class="line">net.ipv4.ip_conntrack_max = 655360</span><br><span class="line">在内核内存中netfilter可以同时处理的“任务”（连接跟踪条目）；</span><br><span class="line">net.ipv4.icmp_ignore_bogus_error_responses = 1</span><br><span class="line">开启恶意icmp错误消息保护；</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">开启SYN洪水攻击保护。</span><br></pre></td></tr></table></figure>

<h4 id="Linux内核报错剖析"><a href="#Linux内核报错剖析" class="headerlink" title="Linux内核报错剖析"></a>Linux内核报错剖析</h4><p>企业生产环境Linux服务器正常运行，由于某种原因会导致内核报错或者抛出很多信息，根据系统SA可以快速定位Linux服务器故障，Linux内核日志一般存在messages日志中，可以通过命令tail -fn 100 /var/log/messages查看Linux内核日志，如下为Linux内核常见报错日志及生产环境解决报错的方案：</p>
<h5 id="Linux内核抛出net-ipv4-tcp-max-tw-buckets错误："><a href="#Linux内核抛出net-ipv4-tcp-max-tw-buckets错误：" class="headerlink" title="Linux内核抛出net.ipv4.tcp_max_tw_buckets错误："></a>Linux内核抛出net.ipv4.tcp_max_tw_buckets错误：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Sep 23 04:45:55 localhost kernel: TCP: time wait bucket table overflow</span><br><span class="line">Sep 23 04:45:55 localhost kernel: TCP: time wait bucket table overflow</span><br><span class="line">Sep 23 04:45:55 localhost kernel: TCP: time wait bucket table overflow</span><br><span class="line">Sep 23 04:45:55 localhost kernel: TCP: time wait bucket table overflow</span><br><span class="line">Sep 23 04:45:55 localhost kernel: TCP: time wait bucket table overflow</span><br><span class="line">Sep 23 04:45:55 localhost kernel: TCP: time wait bucket table overflow</span><br><span class="line">Sep 23 04:45:55 localhost kernel: TCP: time wait bucket table overflow</span><br><span class="line">Sep 23 04:45:55 localhost kernel: TCP: time wait bucket table overflow</span><br><span class="line">Sep 23 04:45:55 localhost kernel: TCP: time wait bucket table overflow</span><br></pre></td></tr></table></figure>

<p>根据TCP协议定义的3次握手及四次断开连接规定，发起socket主动关闭的一方Socket将进入TIME_WAIT状态，TIME_WAIT状态将持续2个MSL(Max Segment Lifetime)。<br>如果该值设置过小导致，当系统Time wait数量超过默认设置的值，即会抛出如上的警告信息，需要增加net.ipv4.tcp_max_tw_buckets的值，警告信息消除。<br>当然也不能设置过大，对于一个处理大量短连接的服务器，如果是由服务器主动关闭客户端的连接，将导致服务器端存在大量的处于TIME_WAIT状态的Socket，甚至比处于Established状态下的Socket多的多，严重影响服务器的处理能力，甚至耗尽可用的Socket而停止服务，TIME_WAIT是TCP协议用以保证被重新分配的Socket不会受到之前残留的延迟重发报文影响的机制，是TCP传输必要的逻辑保证。</p>
<h5 id="Linux内核抛出Too-many-open-files错误："><a href="#Linux内核抛出Too-many-open-files错误：" class="headerlink" title="Linux内核抛出Too many open files错误："></a>Linux内核抛出Too many open files错误：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Benchmarking localhost (be patient)</span><br><span class="line">socket: Too many open files (24)</span><br><span class="line">socket: Too many open files (24)</span><br><span class="line">socket: Too many open files (24)</span><br><span class="line">socket: Too many open files (24)</span><br><span class="line">socket: Too many open files (24)</span><br></pre></td></tr></table></figure>

<p>每个文件描述符与一个打开文件相对应，不同的文件描述符可以指向同一个文件。相同的文件可以被不同的进程打开，也可以在同一个进程中被多次打开。Linux内核对应每个用户打开的文件最大数一般为1024，需要将该值调高满足大并发网站的访问。<br>Linux每个用户打开文件最大数永久设置方法，将如下代码加入内核限制文件/etc/security/limits.conf的末尾，Exit退出终端，重新登录即生效：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat /etc/security/limits.conf</span></span><br><span class="line">*    soft        noproc                  65535</span><br><span class="line">*    hard       noproc                  65535</span><br><span class="line">*    soft        nofile                    65535</span><br><span class="line">*    hard       nofile                    65535</span><br></pre></td></tr></table></figure>

<h5 id="Linux内核抛出possible-SYN-flooding-on-port-80-Sending-cookies错误："><a href="#Linux内核抛出possible-SYN-flooding-on-port-80-Sending-cookies错误：" class="headerlink" title="Linux内核抛出possible SYN flooding on port 80. Sending cookies错误："></a>Linux内核抛出possible SYN flooding on port 80. Sending cookies错误：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">May 31 14:20:14 localhost kernel: possible SYN flooding on port 80. Sending cookies.</span><br><span class="line">May 31 14:21:28 localhost kernel: possible SYN flooding on port 80. Sending cookies.</span><br><span class="line">May 31 14:22:44 localhost kernel: possible SYN flooding on port 80. Sending cookies.</span><br><span class="line">May 31 14:25:33 localhost kernel: possible SYN flooding on port 80. Sending cookies.</span><br><span class="line">May 31 14:27:06 localhost kernel: possible SYN flooding on port 80. Sending cookies.</span><br><span class="line">May 31 14:28:44 localhost kernel: possible SYN flooding on port 80. Sending cookies.</span><br><span class="line">May 31 14:28:51 localhost kernel: possible SYN flooding on port 80. Sending cookies.</span><br><span class="line">May 31 14:31:01 localhost kernel: possible SYN flooding on port 80. Sending cookies.</span><br></pre></td></tr></table></figure>

<p>此问题是由于SYN 队列已满，而触发SYN cookies，一般是由于大量的访问，或者恶意访问导致，也称之为SYN Flooding洪水攻击，与DDOS攻击类似。<br>完整的TCP连接的三次握手，假设一个用户A向服务器发送了SYN报文后突然死机或掉线，那么服务器在发出SYN+ACK应答报文后是无法收到客户端的ACK报文的（第三次握手无法完成），这种情况下服务器端一般会重试（再次发送SYN+ACK给客户端）并等待一段时间后丢弃这个未完成的连接，这段时间的长度我们称为SYN Timeout，一般来说这个时间是分钟的数量级（大约为30秒-2分钟）。<br>一个用户出现异常导致服务器的一个线程等待1分钟并不是什么很大的问题，但如果有一个恶意的攻击者大量模拟这种情况，服务器端将为了维护一个非常大的半连接列表而消耗非常多的资源，数以万计的半连接，即使是简单的保存并遍历也会消耗非常多的CPU时间和内存，何况还要不断对这个列表中的IP进行SYN+ACK的重试。<br>实际上如果服务器的TCP/IP栈不够强大，最后的结果往往是堆栈溢出崩溃，即使服务器端的系统足够强大，服务器端也将忙于处理攻击者伪造的TCP连接请求而无暇理睬客户的正常请求（毕竟客户端的正常请求比率非常之小），此时从正常客户的角度看来，服务器失去响应，服务器拒绝提供服务，服务器受到了DDOS攻击，这里攻击的手段为DDOS中SYN Flood攻击（SYN洪水攻击）。</p>
<h5 id="防护DDOS攻击"><a href="#防护DDOS攻击" class="headerlink" title="防护DDOS攻击"></a>防护DDOS攻击</h5><p>防护DDOS攻击有两种手段，一是基于硬件专业防火墙、二是基于Linux内核简单防护，如果攻击流量特别大，单纯配置内核参数是无法抵挡的，还得依靠专业级硬件防火墙，如下为Linux内核防护DDOS优化参数，加入如下代码即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">net.ipv4.tcp_keepalive_time = 1200</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 8000</span><br><span class="line">net.ipv4.tcp_synack_retries = 2</span><br><span class="line">net.ipv4.tcp_syn_retries = 2</span><br></pre></td></tr></table></figure>

<h5 id="Linux内核抛出ip-conntrack-table-full-dropping-packet-错误："><a href="#Linux内核抛出ip-conntrack-table-full-dropping-packet-错误：" class="headerlink" title="Linux内核抛出ip_conntrack: table full, dropping packet.错误："></a>Linux内核抛出ip_conntrack: table full, dropping packet.错误：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">May  6 11:15:07 localhost kernel: nf_conntrack:table full, dropping packet.</span><br><span class="line">May  6 11:19:13 localhost kernel: nf_conntrack:table full, dropping packet.</span><br><span class="line">May  6 11:20:34 localhost kernel: nf_conntrack:table full, dropping packet.</span><br><span class="line">May  6 11:23:12 localhost kernel: nf_conntrack:table full, dropping packet.</span><br><span class="line">May  6 11:24:07 localhost kernel: nf_conntrack:table full, dropping packet.</span><br><span class="line">May  6 11:24:13 localhost kernel: nf_conntrack:table full, dropping packet.</span><br><span class="line">May  6 11:25:11 localhost kernel: nf_conntrack:table full, dropping packet.</span><br><span class="line">May  6 11:26:25 localhost kernel: nf_conntrack:table full, dropping packet.</span><br></pre></td></tr></table></figure>

<p>由于该服务器开启了iptables防火墙，WEB服务器收到了大量的连接，iptables会把所有的连接都做链接跟踪处理，这样iptables就会有一个链接跟踪表，当这个表满的时候，就会出现上面的错误。ip_conntrack是linux NAT的一个跟踪连接条目的模块，ip_conntrack模块会使用一个哈希表记录 tcp 通讯协议的established connection记录。<br>       如果是CentOS6.x系统，需执行：modprobe nf_conntrack命令，然后在内核优化文件中加入如下代码，sysctl –p使其内核文件生效，即可解决该报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.nf_conntrack_max = 655360</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 36000</span><br></pre></td></tr></table></figure>

<p>如果是CentOS5.x系统，需执行：modprobe ip_conntrack命令，然后在内核优化文件中加入如下代码，sysctl –p使其内核文件生效，即可解决该报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_conntrack_max = 655350</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_tcp_timeout_established = 10800</span><br></pre></td></tr></table></figure>

<h4 id="影响务器性能因素"><a href="#影响务器性能因素" class="headerlink" title="影响务器性能因素"></a>影响务器性能因素</h4><p>影响企业生产环境Linux服务器性能的因素有很多，一般分为两大类，分别为操作系统层级和应用程序级别。如下为各级别影响性能的具体项及性能评估的标准：</p>
<ul>
<li>操作系统级别</li>
<li>内存；</li>
<li>CPU；</li>
<li>磁盘I/O；</li>
<li>网络I/O带宽。</li>
<li>应用程序及软件</li>
<li>Nginx；</li>
<li>MySQL；</li>
<li>Tomcat;</li>
<li>PHP；</li>
<li>应用程序代码。</li>
</ul>
<h4 id="影响性能因素"><a href="#影响性能因素" class="headerlink" title="影响性能因素"></a>影响性能因素</h4><p>评判标准</p>
<ul>
<li>好</li>
<li>坏</li>
<li>糟糕</li>
</ul>
<ul>
<li>CPU<ul>
<li>user% + sys%&lt; 70%</li>
<li>user% + sys%= 85%</li>
<li>user% + sys% &gt;=90%</li>
</ul>
</li>
<li>内存<ul>
<li>Swap In（si）＝0</li>
<li>Swap Out（so）＝0</li>
<li>Per CPU with 10 page/s</li>
<li>More Swap In &amp; Swap Out</li>
</ul>
</li>
<li>磁盘<ul>
<li>iowait % &lt; 20%</li>
<li>iowait % =35%</li>
<li>iowait % &gt;= 50%</li>
</ul>
</li>
</ul>
<h4 id="Linux系统性能分析工具"><a href="#Linux系统性能分析工具" class="headerlink" title="Linux系统性能分析工具"></a>Linux系统性能分析工具</h4><p>常用系统性能分析命令: vmstat、sar、iostat、netstat、free、ps、top、iftop等；</p>
<p>常用系统性能组合分析命令；</p>
<ul>
<li>top、uptime                                  检查系统整体的负载、承受能力；</li>
<li>vmstat、sar、iostat 、top                    检测是否是CPU瓶颈；</li>
<li>free、vmstat                                 检测是否是内存瓶颈；</li>
<li>iostat                                       检测是否是磁盘I/O瓶颈；</li>
<li>netstat、iftop                               检测是否是网络带宽瓶颈。</li>
</ul>
<h4 id="Linux服务器性能评估与优化"><a href="#Linux服务器性能评估与优化" class="headerlink" title="Linux服务器性能评估与优化"></a>Linux服务器性能评估与优化</h4><p>Linux服务器性能评估与优化是一项长期的工作，需要随时关注网站服务器的运行状态，及时作出相应的调整，如下为Linux服务器性能评估及优化方案：</p>
<h5 id="Linux系统整体性能评估"><a href="#Linux系统整体性能评估" class="headerlink" title="Linux系统整体性能评估"></a>Linux系统整体性能评估</h5><p>uptime命令主要用于查看当前服务器整体性能，例如CPU、负载、内存等值的总览，如下为uptime命令应用案例及详解：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 ~]# uptime</span><br><span class="line">13:38:00 up 112 days,  14:01,  5 users,  load average: 6.22, 1.02, 0.91</span><br></pre></td></tr></table></figure>

<p>Load average负载有三个值，分别表示：最近1分钟、5分钟、15分钟系统的负载，三个值的大小一般不能大于系统逻辑CPU核数的2倍，例如Linux操作系统有4个逻辑CPU，如果load average的三个值长期大于8时，说明CPU很繁忙，负载很高，可能会影响系统性能，但是偶尔大于8时，可以不用担心，一般不会影响系统性能。<br>如果load average的输出值小于CPU逻辑个数的2倍，则表示CPU还有空闲的时间片，例如案例中CPU负载为6.22，表示CPU或者服务器是比较空闲的。基于此参数不能完全确认服务器的性能瓶颈，需要借助其他工具进一步判断。</p>
<h5 id="CPU性能评估"><a href="#CPU性能评估" class="headerlink" title="CPU性能评估"></a>CPU性能评估</h5><p>利用vmstat命令监控系统CPU，该命令可以显示关于系统各种资源之间相关性能的简要信息，主要用它来查看CPU负载及队列情况。</p>
<h6 id="Vmstat输出结果详解"><a href="#Vmstat输出结果详解" class="headerlink" title="Vmstat输出结果详解"></a>Vmstat输出结果详解</h6><ul>
<li>r             列表示运行和等待cpu时间片的进程数，这个值如果长期大于系统CPU的个数，说明CPU不足，需要增加CPU；</li>
<li>b             列表示在等待资源的进程数，比如正在等待I/O、或者内存交换等；</li>
<li>us            列显示了用户进程消耗的CPU 时间百分比。us的值比较高时，说明用户进程消耗的cpu时间多，但是如果长期大于50%，就需要考虑优化程序或算法；</li>
<li>sy            列显示了内核进程消耗的CPU时间百分比。Sy的值较高时，说明内核消耗的CPU资源很多；<br>us+sy的参考值为80%，如果us+sy大于80%说明可能存在CPU资源不足。<br>利用sar命令监控系统CPU，sar功能很强大，可以对系统的每个方面进行单独的统计，但是使用sar命令会增加系统开销，不过这些开销是可以评估的，对系统的统计结果不会有很大影响。如图15-7所示，为sar命令对某个系统的CPU统计输出：</li>
</ul>
<h6 id="Sar输出结果详解如下："><a href="#Sar输出结果详解如下：" class="headerlink" title="Sar输出结果详解如下："></a>Sar输出结果详解如下：</h6><ul>
<li>%user                                 列显示了用户进程消耗的CPU 时间百分比；</li>
<li>%nice                                 列显示了运行正常进程所消耗的CPU 时间百分比；</li>
<li>%system                             列显示了系统进程消耗的CPU时间百分比；</li>
<li>%iowait                              列显示了IO等待所占用的CPU时间百分比；</li>
<li>%idle                                  列显示了CPU处在空闲状态的时间百分比；</li>
<li>%steal                                列显示了在内存相对紧张的环境下page in强制对不同的页面进行的steal操作。</li>
</ul>
<h5 id="内存性能评估"><a href="#内存性能评估" class="headerlink" title="内存性能评估"></a>内存性能评估</h5><p>利用free指令监控内存，free是监控linux内存使用状况最常用的指令。</p>
<p>一般而言，服务器内存可以通过如下方法判断是否空余：</p>
<ul>
<li>应用程序可用内存/系统物理内存&gt;70%时，表示系统内存资源非常充足，不影响系统性能。</li>
<li>应用程序可用内存/系统物理内存&lt;20%时，表示系统内存资源紧缺，需要增加系统内存，20%&lt;应用程序可用内存/系统物理内存&lt;70%时，表示系统内存资源基本能满足应用需求，暂时不影响系统性能。</li>
</ul>
<h5 id="磁盘I-O性能评估"><a href="#磁盘I-O性能评估" class="headerlink" title="磁盘I/O性能评估"></a>磁盘I/O性能评估</h5><p>利用iostat评估磁盘性能，监控磁盘IO读写及带宽。</p>
<h6 id="Iostat输出结果详解如下："><a href="#Iostat输出结果详解如下：" class="headerlink" title="Iostat输出结果详解如下："></a>Iostat输出结果详解如下：</h6><ul>
<li>Blk_read/s                表示每秒读取的数据块数；</li>
<li>Blk_wrtn/s                表示每秒写入的数据块数；</li>
<li>Blk_read                  表示读取的所有块数；</li>
<li>Blk_wrtn                  表示写入的所有块数。</li>
</ul>
<p>可以通过Blk_read/s和Blk_wrtn/s的值对磁盘的读写性能有一个基本的了解，如果Blk_wrtn/s值很大，表示磁盘的写操作很频繁，可以考虑优化磁盘或者优化程序，如果Blk_read/s值很大，表示磁盘直接读取操作很多，可以将读取的数据放入内存中进行操作。</p>
<p>利用sar评估磁盘性能，通过sar -d组合，可以对系统的磁盘IO做一个基本的统计。</p>
<h6 id="Sar输出结果详解如下：-1"><a href="#Sar输出结果详解如下：-1" class="headerlink" title="Sar输出结果详解如下："></a>Sar输出结果详解如下：</h6><ul>
<li>await表示平均每次设备I/O操作的等待时间（以毫秒为单位）；</li>
<li>svctm表示平均每次设备I/O操作的服务时间（以毫秒为单位）；</li>
<li>%util表示一秒中有百分之几的时间用于I/O操作；</li>
</ul>
<p>磁盘IO性能，评判标准：正常情况下svctm应该是小于await值的，而svctm的大小和磁盘性能有关，CPU、内存的负荷也会对svctm值造成影响，过多的请求也会间接的导致svctm值的增加。<br>await值的大小一般取决与svctm的值和I/O队列长度以及I/O请求模式，如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，系统上运行的应用程序将变慢，此时可以通过更换更快的硬盘来解决问题。<br>%util项的值也是衡量磁盘I/O的一个重要指标，如果%util接近100%，表示磁盘产生的I/O请求太多，I/O系统已经满负荷的在工作，该磁盘可能存在瓶颈。长期下去，势必影响系统的性能，可以通过优化程序或者通过更换更高、更快的磁盘来解决此问题。</p>
<h4 id="网络性能评估"><a href="#网络性能评估" class="headerlink" title="网络性能评估"></a>网络性能评估</h4><ul>
<li>通过ping命令检测网络的连通性</li>
<li>通过netstat –i组合检测网络接口状况</li>
<li>通过netstat –r组合检测系统的路由表信息</li>
<li>通过sar -n组合显示系统的网络运行状态</li>
<li>通过iftop -i eth0 查看网卡流量，详细参数如下，</li>
</ul>
<p>&lt;=                               客户端流入的流量；</p>
<p>=&gt;                               服务器端流出的流量；</p>
<p>TX                              发送流量；</p>
<p>RX                              接收流量；</p>
<p>TOTAL                       总流量；</p>
<p>Cumm                         运行iftop到目前时间的总流量；</p>
<p>peak                         流量峰值；</p>
<p>rates                         分别表示过去 2s 10s 40s 的平均流量。</p>

    </div>

    
    
    
        
      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/运维基本功/" rel="tag"><i class="fa fa-tag"></i>运维基本功</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/post/651295d4.html" rel="next" title="pyenv安装">
                  <i class="fa fa-chevron-left"></i> pyenv安装
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/post/59899.html" rel="prev" title="RAID简介">
                  RAID简介 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-IP报文详解"><span class="nav-number">1.</span> <span class="nav-text">TCP/IP报文详解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP三次握手原理："><span class="nav-number">2.</span> <span class="nav-text">TCP三次握手原理：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#优化Linux文件打开最大数"><span class="nav-number">3.</span> <span class="nav-text">优化Linux文件打开最大数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux内核常见参数详解："><span class="nav-number">4.</span> <span class="nav-text">Linux内核常见参数详解：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux内核报错剖析"><span class="nav-number">5.</span> <span class="nav-text">Linux内核报错剖析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Linux内核抛出net-ipv4-tcp-max-tw-buckets错误："><span class="nav-number">5.1.</span> <span class="nav-text">Linux内核抛出net.ipv4.tcp_max_tw_buckets错误：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Linux内核抛出Too-many-open-files错误："><span class="nav-number">5.2.</span> <span class="nav-text">Linux内核抛出Too many open files错误：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Linux内核抛出possible-SYN-flooding-on-port-80-Sending-cookies错误："><span class="nav-number">5.3.</span> <span class="nav-text">Linux内核抛出possible SYN flooding on port 80. Sending cookies错误：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#防护DDOS攻击"><span class="nav-number">5.4.</span> <span class="nav-text">防护DDOS攻击</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Linux内核抛出ip-conntrack-table-full-dropping-packet-错误："><span class="nav-number">5.5.</span> <span class="nav-text">Linux内核抛出ip_conntrack: table full, dropping packet.错误：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#影响务器性能因素"><span class="nav-number">6.</span> <span class="nav-text">影响务器性能因素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#影响性能因素"><span class="nav-number">7.</span> <span class="nav-text">影响性能因素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux系统性能分析工具"><span class="nav-number">8.</span> <span class="nav-text">Linux系统性能分析工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux服务器性能评估与优化"><span class="nav-number">9.</span> <span class="nav-text">Linux服务器性能评估与优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Linux系统整体性能评估"><span class="nav-number">9.1.</span> <span class="nav-text">Linux系统整体性能评估</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CPU性能评估"><span class="nav-number">9.2.</span> <span class="nav-text">CPU性能评估</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Vmstat输出结果详解"><span class="nav-number">9.2.1.</span> <span class="nav-text">Vmstat输出结果详解</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Sar输出结果详解如下："><span class="nav-number">9.2.2.</span> <span class="nav-text">Sar输出结果详解如下：</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#内存性能评估"><span class="nav-number">9.3.</span> <span class="nav-text">内存性能评估</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#磁盘I-O性能评估"><span class="nav-number">9.4.</span> <span class="nav-text">磁盘I/O性能评估</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Iostat输出结果详解如下："><span class="nav-number">9.4.1.</span> <span class="nav-text">Iostat输出结果详解如下：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Sar输出结果详解如下：-1"><span class="nav-number">9.4.2.</span> <span class="nav-text">Sar输出结果详解如下：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#网络性能评估"><span class="nav-number">10.</span> <span class="nav-text">网络性能评估</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.jpg"
      alt="Mr.Chen">
  <p class="site-author-name" itemprop="name">Mr.Chen</p>
  <div class="site-description" itemprop="description">个人博客系统</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/tanlay" title="GitHub &rarr; https://github.com/tanlay" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:dooktmint@gmail.com" title="E-Mail &rarr; mailto:dooktmint@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
    
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.Chen</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

<!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
</body>
</html>
